

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Generic 说明 &mdash; Uliweb Documentation 0.1.4 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="Uliweb Documentation 0.1.4 documentation" href="index.html" />
    <link rel="next" title="如何测试" href="test.html" />
    <link rel="prev" title="Middleware 开发" href="middleware.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="test.html" title="如何测试"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="middleware.html" title="Middleware 开发"
             accesskey="P">上一页</a> |</li>
        <li><a href="index.html">Uliweb Documentation 0.1.4 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="generic">
<h1>Generic 说明<a class="headerlink" href="#generic" title="永久链接至标题">¶</a></h1>
<div class="section" id="genric">
<h2>Genric是什么？<a class="headerlink" href="#genric" title="永久链接至标题">¶</a></h2>
<p>在编写View相关的代码时，我们遇到最多的处理恐怕就是：列表显示、添加、删除、更新、修改
了，一般的叫法是CRUD(Create, Read, Update, Delete)这里没有List。那么Generic的目的
就是把这些常见的处理进行封装，并且它可以和Uliorm相结合，可以比较容易地对表中的
记录进行处理。在Uliweb的utils/generic.py中提供了上述的功能。</p>
<p>generic的整个设计思路是为了将处理程流进行复用。首先是根据按执行的功能分为不同的类。
然后将完整的处理流程封装到类中。但是在实际处理过程中，总会有各种各样的特殊的要求，
因此，你有两种扩展的方式：一种是派生新的类，另一种是将必要的参数和回调传入初始化
函数。一般的方式是采用第二种，因为这种方式相对简单。</p>
<p>generic主要是对Model的界面处理进行了自动化，所以它主要是和Model相结合使用。</p>
<p>在generic中，针对不同的处理提供了不同的View Class，下面分别进行介绍。</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">本文档附带了一个示例，可以从 uliweb-doc/projects/genric_blog 中找到。</p>
</div>
</div>
<div class="section" id="listview">
<h2>ListView<a class="headerlink" href="#listview" title="永久链接至标题">¶</a></h2>
<p>ListView用来处理列表显示。在最简单的情况下，你可能只需要在view中返回一个结果集，
然后在模板中对它进行展示。不过，这样一些处理将会集中在模板中。而ListView通过丰
富的参数，可以比较方便地进行：设置条件、处理字段、字段值的加工、不同的展示方式、
下载支持等。</p>
<div class="section" id="id1">
<h3>ListView参数说明<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<div class="highlight-python"><pre>class ListView(SimpleListView):
    def __init__(self, model, condition=None, query=None, pageno=0, order_by=None,
        fields=None, rows_per_page=10, types_convert_map=None, pagination=True,
        fields_convert_map=None, id='listview_table', table_class_attr='table',
        table_width=True, total_fields=None, template_data=None,
        default_column_width=100, meta='Table', render=None):</pre>
</div>
<p>上面是ListView的初始化函数的定义，可以看到它提供了大量的参数。同时用户也可以根
据需要从ListView类进行派生。ListView是从SimpleListView派生来的，它主要用来处理
与Model相关的列表展示，而SimpleListView主要是处理查询后的结果，不直接与Model
绑定。下面对每个参数进行说明:</p>
<dl class="docutils">
<dt>model</dt>
<dd>ListView要绑定的Model，这个Model将是显示的主体。</dd>
<dt>condition</dt>
<dd>查询条件。在执行时，ListView将会按 model.filter(condition)的形式来获得结果
集。</dd>
<dt>query</dt>
<dd>结果集。如果用户传入了一个在model上的结果集，则它将结合condition条件，使用
query.filter(condition)来获得结果。这里就不再是model对象了，而是传入的query
对象。所以用户要保证这个query是操作model得到的结果集。</dd>
<dt>order_by</dt>
<dd><p class="first">对查询结果进行排序。它可以是排序字段的列表，写法要符合sqlalchemy的要求，比如:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<p class="last">可以有多个排序字段，可以按升序或降序排序。</p>
</dd>
<dt>pageno</dt>
<dd>页号。ListView支持分页查询。第一页是从0开始。</dd>
<dt>rows_per_page</dt>
<dd>每页显示的记录条数。</dd>
<dt>pagination</dt>
<dd>是否使用分页方式的标志。缺省为使用。如果为False则不使用分页方式。</dd>
<dt>fields</dt>
<dd>用于传入需要显示的字段列表。如果没有给出，则自动使得后面的meta字段所指定的，
定义在Model中的特殊子类的fields属性。具体的参见下面的关于字段列表定义的说明。</dd>
<dt>types_convert_map</dt>
<dd>用来定义字段类型与显示值处理函数的映射。具体说明，参见下面关于字段的展示的
说明。它同下面的fields_convert_map类似，只不过fields_convert_map只处理特定
名字的字段，只能是一个字段；而types_convert_map是处理特定类型的字段，可能是
多个字段。</dd>
<dt>fields_convert_map</dt>
<dd>用来定义字段与显示值处理函数的映射。具体说明，参见下面关于字段的展示的
说明。</dd>
<dt>id</dt>
<dd>生成页面时&lt;table&gt;元素的id属性名。</dd>
<dt>table_class_attr</dt>
<dd>用于指明&lt;table&gt;元素的class属性值。</dd>
<dt>table_width</dt>
<dd>是否指定表格以像素计算的宽度，如果是，则会根据每列的宽度进行计算总宽度，然后
设置表格的总宽度。</dd>
<dt>default_column_width</dt>
<dd>缺省每列的像素宽度，缺省为100px。</dd>
<dt>total_fields</dt>
<dd>用于合计字段的计算。</dd>
<dt>template_date</dt>
<dd>将传入模板中的变量dict。</dd>
<dt>meta</dt>
<dd>如果使用Model中的字段定义，则使用指定名字的子类中的fields属性。缺省为 <cite>&#8216;Table&#8217;</cite> ，
你可以指定其它的名字。</dd>
<dt>render</dt>
<dd>如果不希望ListView按缺省的数据加工方法对数据进行处理，可以传入自定义的render
函数。它是一个回调，调用形式为: <tt class="docutils literal"><span class="pre">render(record,</span> <span class="pre">obj)</span></tt> ，record为正在处理的记录，
它的值是一个二元的tuple，形式为: <tt class="docutils literal"><span class="pre">(name,</span> <span class="pre">display)</span></tt> 。obj为当前正在处理的对
象。</dd>
</dl>
</div>
<div class="section" id="id2">
<h3>字段列表定义<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>在ListView中，用户可以有两种定义列表显示字段的方式：</p>
<ol class="arabic simple">
<li>通过fields字段，传入字段列表</li>
<li>通过在Model类中定义一个子类，来定义字段列表</li>
</ol>
<p>第一种方法可以在运行时根据需要动态修改显示字段的列表，而第二种相对静态。代码示
例如下:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;age&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="s">&#39;plan_stat&#39;</span><span class="p">,</span><span class="s">&#39;verbose_name&#39;</span><span class="p">:</span><span class="s">&#39;计划状态&#39;</span><span class="p">,</span> <span class="s">&#39;width&#39;</span><span class="p">:</span><span class="mi">80</span><span class="p">},</span>
        <span class="p">]</span>
</pre></div>
</div>
<p>上面代码是在view代码中定义fields的示例。它支持简单的字段，即只列出字段名称。一
般这种情况下，字段名称在Model中应有对应的属性。比如上例中，应该在传入的Model
对象中有&#8217;name, &#8216;age&#8217;, &#8216;main_sys&#8217;这几个字段。对于复杂的字段，如上例中的dict方式
定义的字段，它主要是用于Model中不存在的字段，因此你需要定义以下几个属性:</p>
<dl class="docutils">
<dt>name</dt>
<dd>字段的名字，英文名</dd>
<dt>verbose_name</dt>
<dd>显示用的名字。如果没有，则使用name值</dd>
<dt>width</dt>
<dd>可选，这个是与生成的表格相关的。generic.py缺省可以提供使用&lt;table&gt;生成的清
单。也支持使用jquery easyui的datagrid生成的表格。这个参数是用来定义列的宽
度。缺省不定义的话宽度是100px。</dd>
<dt>sortable</dt>
<dd>可选。这个也是与使用jquery easyui有关的，其它的情况下，要么你从ListView派生
新的子类，对生成&lt;table&gt;进行了处理，可以考虑定义它，如果不是，则没有什么用。</dd>
</dl>
<p>因此上面name和verbose_name一般是必须的，其它的根据需要来使用。并且，定义哪些值
还和将来展示时使用的包有关系，这块也可以自已去扩展。</p>
<p>第二种方法示例:</p>
<div class="highlight-python"><pre>class Test(Model):
    name = Field(str, max_length=30, verbose_name='姓名')
    age = Field(int, verbose_name='年龄'

    class Table:
        fields = [
            {'name':'name', 'width':150},
            'age',
        ]</pre>
</div>
<p>上面的定义也支持不存在的字段，支持简单定义和复杂定义。</p>
</div>
<div class="section" id="id3">
<h3>执行流程描述<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>先给出代码示例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">uliweb.utils.generic</span> <span class="kn">import</span> <span class="n">ListView</span>

    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_url</span><span class="p">()</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">ListView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">fields_convert_map</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span><span class="n">title</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic">
<li><p class="first">从 generic 中导入 ListView 。</p>
</li>
<li><p class="first">根据需要对需要传入 ListView 中的参数或回调函数进行处理</p>
</li>
<li><p class="first">创建 ListView 实例</p>
</li>
<li><p class="first">返回 view.run()，它将返回一个 dict ，包含内容为:</p>
<div class="highlight-python"><pre>{'table':以table方式显示的表格数据,
 'table_id':table的id,
 'total':总条数,
 'pageno':当前页号,
 'page_rows':每页显示的条数
}</pre>
</div>
<p>同时它还包含了传入到template_data中的数据。</p>
</li>
</ol>
<p>所以在最简单的情况下，对应的模板可以写为:</p>
<div class="highlight-python"><pre>{{extend "BlogView/layout.html"}}

{{block content}}
&lt;a href="/add"&gt;添加Blog&lt;/a&gt;
{{&lt;&lt; table}}
{{end}}</pre>
</div>
<p>直接展示 <tt class="docutils literal"><span class="pre">{{&lt;&lt;table}}</span></tt> 即可。</p>
</div>
<div class="section" id="id4">
<h3>字段转換<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>ListView中可以对某个字段的值进行转換，同时这种转換支持对不存在的字段进行处理。
这里要使用 fields_convert_map 这个参数，它是一个 dict ，key就是要转換的字段名，
value是对应的转換函数。转換函数定义为:</p>
<div class="highlight-python"><pre>def convert(value, obj):</pre>
</div>
<p>其中value为对应字段的值，obj为对应的记录对象。你需要返回一个字符串。举例如下:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;/view/</span><span class="si">%d</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="n">fields_convert_map</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span><span class="n">title</span><span class="p">}</span>
<span class="n">view</span> <span class="o">=</span> <span class="n">ListView</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields_convert_map</span><span class="o">=</span><span class="n">fields_convert_map</span><span class="p">)</span>
</pre></div>
</div>
<p>这样就可以在显示 title 字段时调用 title() 函数返回一个链接。</p>
</div>
<div class="section" id="id5">
<h3>不存在字段支持<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>如果是处理不存在的字段，第一步是在传入的 fields 中或在 class Table 中定义这个字
段的复杂方式，即至少要定义为一个dict，而且包含: name, verbose_name 属性。然后定义
一个convert函数，并且配置到 fields_convert_map 中。要记住，因为字段本身在 Model
中可能不存在，所以 value 是无值的，你只能使用 obj 或通过缺省值来传入其它的参数。
举例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="s">&#39;action&#39;</span><span class="p">,</span> <span class="s">&#39;verbose_name&#39;</span><span class="p">:</span><span class="s">&#39;操作&#39;</span><span class="p">}]</span>

<span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;/delete/</span><span class="si">%d</span><span class="s">&quot;&gt;删除&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span>

<span class="n">fields_convert_map</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;action&#39;</span><span class="p">:</span><span class="n">action</span><span class="p">}</span>
<span class="n">view</span> <span class="o">=</span> <span class="n">ListView</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields_convert_map</span><span class="o">=</span><span class="n">fields_convert_map</span><span class="p">)</span>
</pre></div>
</div>
<p>采用这种方式，我们定义了一个不存在的 action 字段，它的内容是删除链接。</p>
</div>
<div class="section" id="view">
<h3>跳转到 View 页面<a class="headerlink" href="#view" title="永久链接至标题">¶</a></h3>
<p>View页面一般是用来显示详细信息的，因此在显示 List 内容时，我们需要某种方法从 List
页面跳转到 View 页面。那么通常的办法就是选一个合适的字段，对它写一个 convert 函数，
返回一个跳转到view页面的链接即可。代码不再提供。</p>
</div>
<div class="section" id="ajax">
<h3>Ajax请求处理<a class="headerlink" href="#ajax" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="jquery-easyui">
<h3>与jquery easyui的结合<a class="headerlink" href="#jquery-easyui" title="永久链接至标题">¶</a></h3>
</div>
<div class="section" id="id6">
<h3>分页处理<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>ListView可以分页也可以不分页。缺省情况下 <tt class="docutils literal"><span class="pre">pagination=True</span></tt> 表示分页。当处于分页
情况下，用户可以传入pageno和rows_per_page来控制起始的页号和每页显示的条数。如何获
得这些信息，你需要在ListView之外进行获取。</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">那么，为什么不将这个处理直接封装到 ListView中呢？因为随着前端使用的控件不同
可能会返回不同的分页关键字，比如有的使用 page和rows。所以你一般要在调用 ListView
之前进行转換。</p>
</div>
</div>
<div class="section" id="id7">
<h3>查询与条件<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>在ListView中，第一个参数是Model的名字或类，那么为了返回正确的记录，你还可以传入
condition或query。其中condition对应合适查询条件，而query则对应合适的结果集。最终
的结果将由于传入这些参数而发生变化。整个查询的伪代码为:</p>
<div class="highlight-python"><pre>if 传入了query:
    结果集 = query
else:
    结果集 = self.model.all()
if condition is not None:
    结果集 = 结果集.filter(condition)
if 需要分页:
    结果集 = 结果集.offset((页号-1)*每页条数).limit(每页条数)</pre>
</div>
</div>
</div>
<div class="section" id="simplelistview">
<h2>SimpleListView<a class="headerlink" href="#simplelistview" title="永久链接至标题">¶</a></h2>
<p>因为ListView是针对某个Model的，因此它也有一定的局限，比如在处理复杂的多表关联或
数据加工的结果就无能为力。所以SimpleListView是不与某个Model关联的，也因此你需要
定义一个表头，然后将其传入SimpleListView中。同时在convert中的obj参数值也将不再是
某个Model的对象，而有可能是一个dict或SQLAlchemy的ResultProxy对象。同时SimpleListView
也支持简单的select语句，但是在这种情况下表头还是要定义的。</p>
<div class="section" id="id8">
<h3>参数说明<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<div class="highlight-python"><pre>class SimpleListView(object):
    def __init__(self, fields=None, query=None,
        pageno=0, rows_per_page=10, id='listview_table', fields_convert_map=None,
        table_class_attr='table', table_width=False, pagination=True, total_fields=None,
        template_data=None, default_column_width=100, total=None, manual=False, render=None):</pre>
</div>
<p>SimpleListView的参数和 ListView的差不多，与ListView相似的参数就不再解释了，只
强调一下与ListView不同或新増的参数：</p>
<dl class="docutils">
<dt>total</dt>
<dd>记录总数。与后面的manual一般联用。这是为了避免通过循环的方式得到记录总数。</dd>
<dt>manual</dt>
<dd>是否手动传入记录总数。如果不是手动，则表示SimpleListView会自动对结果进行计数，
它一般是采用循环的方式，这样每次显示都要从头到尾遍历一遍，效率会很低。所以
可以在外部先统计好再传入，从而提高效率。</dd>
</dl>
</div>
</div>
<div class="section" id="addview">
<h2>AddView<a class="headerlink" href="#addview" title="永久链接至标题">¶</a></h2>
<div class="section" id="id9">
<h3>参数说明<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<div class="highlight-python"><pre>class AddView(object):
    success_msg = _('The information has been saved successfully!')
    fail_msg = _('There are somethings wrong.')
    builds_args_map = {}

    def __init__(self, model, ok_url=None, ok_template=None, form=None,
        success_msg=None, fail_msg=None, use_flash=True,
        data=None, default_data=None, fields=None, form_cls=None, form_args=None,
        static_fields=None, hidden_fields=None, pre_save=None, post_save=None,
        post_created_form=None, layout=None, file_replace=True, template_data=None,
        success_data=None, meta='AddForm', get_form_field=None, post_fail=None,
        types_convert_map=None, fields_convert_map=None, json_func=None,
        file_convert=True):</pre>
</div>
<dl class="docutils">
<dt>model</dt>
<dd>此AddView所要处理的Model类或名称</dd>
<dt>ok_url</dt>
<dd><p class="first">成功后转換的URL地址。注意，它可以是一个回调函数，形式为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;/view/</span><span class="si">%d</span><span class="s">&quot;&gt;查看&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="nb">id</span>
</pre></div>
</div>
<p class="last">为什么需要使用回调。因为它是基于这样的处理：在添加完记录后，需要跳转到view页
面。但是在调用AddView时，因为相应的对象还没有创建，所以没有对应的id，这样就
没有办法在调用时就传入还不存在的URL。因此采用回调的方式，会将保存后的id传入
回调函数，这样就可以动态创建新对象的URL地址了。如果不是跳转到view页面，则可
以考虑不采用回调。</p>
</dd>
<dt>ok_template</dt>
<dd>如果用户没有定义ok_template，并且不是json的返回方式，则将使用这个参数定义的
模板来展示页面。</dd>
<dt>form</dt>
<dd>对应的form对象。在缺省情况下，用户不需要传入Form相关的参数，AddView会自动根
据model、fields或meta参数来自动生成一个Form对象。但是在某些特殊的情况下，也
可以将一个生成好的form对象传给AddView，这样AddView就不会自动创建Form对象了。</dd>
<dt>form_cls</dt>
<dd>form是对应Form的对象。而form_cls是对应的Form类本身。AddView会自动使用form_cls
来创建form对象。使用form_cls的主要作用是定义校验处理，详情见下面的[数据校验处理]。</dd>
<dt>form_args</dt>
<dd><p class="first">此参数将在生成Form实例时传入。它是一个dict，主要可以使用的参数如:</p>
<div class="last highlight-python"><pre>{'action':提交对应的url,
 'method':提交方法，缺省为POST,
 'html_attrs':创建&lt;form&gt;时将使用的HTML的样式,
        #它也是一个dict，可以使用 {'id':Form的id值, 'class':类名} 等
 'buttons':对应的按钮
}</pre>
</div>
</dd>
<dt>static_fields</dt>
<dd>标识哪些是静态字段。有时我们定义在fiells或AddForm中的字段并不都是需要编辑的，
而是只读的字段，通过这个参数可以指定哪些是只读字段。不过要注意的是，这些字段
在用户提交后不会在提交数据中存在。</dd>
<dt>hidden_fields</dt>
<dd>隐藏字段。指定的字段将生成为 <tt class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;</span> <span class="pre">name=&quot;field_name&quot;</span> <span class="pre">value=&quot;xxx&quot;&gt;&lt;/input&gt;</span></tt></dd>
<dt>success_msg</dt>
<dd>成功后的提示信息。这里AddView会自动调用flash函数。在uliweb中缺省提供了一个
uliweb.contrib.flashmessage的app，你需要把它加入到settings.ini中的INSTALLED_APPS中去。
flash的工作原理是通过session来保存下一个页面要显示的内容。所以在返回结果或跳
转到新页面时，新的页面或模板需要对session中的flash的信息进行处理。如果你使用
plugs项目，它有一个 ui.jquery.pnofity 的app是flashmessage的jquery的版本，可以
通过js的方式显示一个弹出窗口来展示，效果要好于flashmessage。因为flashmessage
是静态信息。</dd>
<dt>fail_msg</dt>
<dd>出错后的提示消息。</dd>
<dt>use_flash</dt>
<dd>是否信息提示采用flash方式，缺省为True。如果为Flash，则不会使用flash函数来显示
提示信息。</dd>
<dt>data</dt>
<dd>传入到Form对象中的数据，它将作为初始值传入。如果用户提交后出错，则只会显示
用户提交的数据。data只是在第一次显示时生效。它是一个dict，key就是对应的字段
名。value为对应的字段类型的值。</dd>
<dt>default_data</dt>
<dd>在保存数据到Model中时，如果用户没有输入值，则使用default_data中的数据，它作
为相应字段的缺省值。与data的区别：data是作为Form的初始值，default_data作为
Model的初始值。</dd>
<dt>fields</dt>
<dd>可添加字段的列表。一个Model中可能有很多字段，但不是所有字段都需要在添加时录
入数据，因此可以通过fields来传入可编辑的字段列表。它也支持添加不存在的字段。
如果存在，则还需要提供get_form_field回调函数，详情见[处理不存在字段]的说明。
fields的处理和ListView的类似，它是一种动态的处理方式。如果是相对静态，可以
直接在Model中定义一个 AddForm 的class，在其中定义 fields。如果不想用AddForm
的名字，那么可以通过传入meta参数来改变。</dd>
<dt>get_form_field</dt>
<dd>如果在fields或AddForm中给出Model中不存在的字段时，AddView会自动调用这个回调
函数来获得想要的字段对象。具体描述参见下面的[处理不存在的字段]。</dd>
<dt>pre_save</dt>
<dd><p class="first">在保存前要执行的回调函数，它的定义为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">pre_save</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p class="last">其中，data是一个dict，并且它将直接会传入到AddView所关联的Model中，所以你可以
在这里通过修改data的值或添加新的值，从而影响保存到Model的数据。因此可以在这里
来设置缺省值，或对数据进行进一步加工。</p>
</dd>
<dt>post_save</dt>
<dd><p class="first">在保存后要执行的回调函数，它的定义为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">post_save</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    obj 为保存后创建的对象</span>
<span class="sd">    data 为保存时使用的data数据</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p class="last">如果在保存完某个对象后，还要进行其它的Model的操作，那么在post_save中是合适的
位置。</p>
</dd>
<dt>post_created_form</dt>
<dd><p class="first">在创建完Form实例后将要调用的回调函数。它允许你对生成的Form作进一步的加工，比
如将原来非必输项的某个字段的required属性改为True，从而变成必输项。它的定义为:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">post_created_form</span><span class="p">(</span><span class="n">fcls</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fcls 是对应的Form类</span>
<span class="sd">    model 是对应的Model类</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
</dd>
<dt>layout</dt>
<dd>uliweb中的Form支持不同的布局处理。一个布局是用来处理Form展示的类，它可以决
定是使用table还是div来展示一个form。具体layout的用途和对应的layout_cls有关。
详情参见[Form的布局处理]</dd>
<dt>file_replace</dt>
<dd>AddForm可以支持在上传Form数据时同时上传文件。这个参数用来控制，如果出现同名
文件时，是否要替換重名的文件。现在Uliweb在上传时，可以控制是不是要对文件名
进行特殊处理，比如使用UUID来生成文件名。这样其实是不会重名的。但是如果不进
行特殊处理是有可能重名。如果重名，并且不进行替換，那么文件名会自动在后面添
加 <tt class="docutils literal"><span class="pre">(n)</span></tt> 这样的信息。</dd>
<dt>file_convert</dt>
<dd>是否对上传的文件名进行转換，如果不转換则将保留原来的文件名。同时结合上面的
<tt class="docutils literal"><span class="pre">file_replace</span></tt> 将会对重名文件进行特殊的处理。</dd>
<dt>template_data</dt>
<dd>将同时传入模板中的其它的数据。</dd>
<dt>success_data</dt>
<dd><p class="first">此参数可以有几个值，它是与返回json数据有关。如果在执行run()时传入了 run(json_result=True)
则表示返回结果为一个json的数据。这时，如果成功则会根据success_data的值来决定
返回的json内容。</p>
<dl class="last docutils">
<dt>True</dt>
<dd>表示使用缺省的结果返回，那么它会简单的调用创建对象的to_dict()方法生成一个
dict，然后返回。</dd>
<dt>function</dt>
<dd><p class="first">如果要自已加工，则可以传入一个回调函数，形式为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">success_data</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    obj为新创建的对象</span>
<span class="sd">    data为保存时使用的数据</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p class="last">这个函数需要返回一个dict值。</p>
</dd>
</dl>
</dd>
<dt>json_func</dt>
<dd><p class="first">当返回结果为json是，一般情况下会使用uliweb的json函数。但是有些情况，如在ie中使用
了iframe处理方式来调用jquery的jquery.form插件时，会有问题，原因是json返回的content_type
不正确。这里不能简单地返回 <tt class="docutils literal"><span class="pre">application/json</span></tt> 的类型，而是要返回 <tt class="docutils literal"><span class="pre">text/html</span></tt>
类型，示例代码如:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="n">json_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text/html;charset=utf-8&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>meta</dt>
<dd>静态字段集定义所对应的class名。</dd>
<dt>post_fail</dt>
<dd>上传数据校验失败后的回调函数处理。</dd>
<dt>types_convert_map</dt>
<dd>类型转換映射。</dd>
<dt>fields_convert_map</dt>
<dd>字段转換映射。它与上面的types_convert_map都是用来对静态字段进行转換处理的。
关于字段转換，详情参见ListView中的[字段转換]说明。</dd>
</dl>
</div>
<div class="section" id="id10">
<h3>简单代码示例<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">uliweb.utils.generic</span> <span class="kn">import</span> <span class="n">AddView</span>

    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span><span class="n">BlogView</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="n">view</span> <span class="o">=</span> <span class="n">AddView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">ok_url</span><span class="o">=</span><span class="n">get_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>这是一段View的代码。它创建了一个AddView，而是定义了一个get_url函数用以响应保存
成功后的URL跳转。</p>
<p>对应的模板为:</p>
<div class="highlight-python"><pre>{{extend "BlogView/layout.html"}}

{{block content}}
&lt;h2&gt;添加&lt;/h2&gt;
{{&lt;&lt; form}}
{{end}}</pre>
</div>
<p>View中会返回一个form对象，它就是用来接受用户输入的表格。可以直接在模板中通过
<tt class="docutils literal"><span class="pre">{{&lt;&lt;form}}</span></tt> 来显示出来。</p>
</div>
<div class="section" id="id11">
<h3>执行流程描述<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>在处理完列表展示之后，我们一般要做的第一件事就是添加记录。在添加记录前应该先有一
个入口，我们一般会放在 List 的页面中。作为一个标准的 HTML 的页面编辑的处理，先
考虑采用以下的处理流程:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uliweb</span> <span class="kn">import</span> <span class="n">request</span>

<span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_form</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>    <span class="c">#创建form</span>

<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>        <span class="c">#如果是POST则表示用户进行了提交</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="c">#对数据进行校验</span>
    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>    <span class="c">#返回True，表示校验成功</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    <span class="c">#对缺省值进行拷贝</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>        <span class="c">#与提交的数据进行合并</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_save</span><span class="p">:</span>               <span class="c">#处理pre_save回调</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_save</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_files</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>       <span class="c">#处理文件</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>        <span class="c">#保存Model对象</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_save</span><span class="p">:</span>              <span class="c">#处理post_save回调</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_save</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">json_result</span><span class="p">:</span>                 <span class="c">#如果需要json数据，则进行json化处理</span>
            <span class="k">return</span> <span class="n">to_json_result</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_msg</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_success_data</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">json_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">flash</span>     <span class="c">#如果是普通的HTML方式，则获得flash函数</span>
            <span class="n">flash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_msg</span><span class="p">)</span>     <span class="c">#显示成功信息</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok_url</span><span class="p">:</span>             <span class="c">#如果指定了ok_url则进行跳转</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">get_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ok_url</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="c">#否则根据传入的模板进行处理</span>
                <span class="n">response</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok_template</span>
                <span class="k">return</span> <span class="n">d</span>
    <span class="k">else</span><span class="p">:</span>       <span class="c">#返回False，表示校验失败，进行出错处理</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c">#拷贝模板数据</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_static_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="c">#准备静态数据</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>            <span class="c">#将数据与Form进行绑定，作为初始值</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">})</span>    <span class="c">#将form对象放入模板数据中</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_fail</span><span class="p">:</span>              <span class="c">#处理post_fail回调函数</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_fail</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">json_result</span><span class="p">:</span>                 <span class="c">#如果需要json数据，则进行json化处理</span>
            <span class="k">return</span> <span class="n">to_json_result</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_msg</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">json_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">flash</span>
            <span class="n">flash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fail_msg</span><span class="p">,</span> <span class="s">&#39;error&#39;</span><span class="p">)</span><span class="c">#显示出错信息</span>
            <span class="k">return</span> <span class="n">d</span>
<span class="k">else</span><span class="p">:</span>                               <span class="c">#显示编辑页面</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_static_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="c">#对静态数据进行处理</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>            <span class="c">#将数据与Form进行绑定，作为初始值</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">json_result</span><span class="p">)</span><span class="c">#展示页面</span>
</pre></div>
</div>
<p>从上面的流程我们大概可以了解整个AddView所做的处理。上面并不是真正的代码，不过已
经和真正的代码非常接近。简单描述起来，一个添加或编辑处理大概分三个步骤:</p>
<ol class="arabic simple">
<li>如果是 GET 请求，则显示编辑界面</li>
<li>如果是 POST 请求，则对数据进行校验，如果成功则保存，返回结果</li>
<li>如果失败，则返回出错结果</li>
</ol>
<p>上面的代码之所以看上去复杂，是因为要支持用户的扩展，所以在许多地方都添加了回调
和参数，允许用户对执行过程进行扩展。用户可以根据需要传入不同的回调来进行特殊的
处理。除了采用回调方式外，用户也可以对AddView类进行继承。</p>
</div>
<div class="section" id="id12">
<h3>录入字段的配置<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<p>前面说到，AddView支持通过fields参数来设定哪些字段可以编辑，也可以支持在Model中
定义一个AddForm的class，示例如下:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__verbose_name__</span> <span class="o">=</span> <span class="s">&#39;Blog&#39;</span>

    <span class="c">#author = Reference(&#39;user&#39;, verbose_name=&#39;作者&#39;, required=True)</span>
    <span class="n">create_date</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;发表时间&#39;</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;标题&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">TEXT</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;内容&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">deleted</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39;删除标志&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">AddForm</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>这样，在AddForm中我们只定义了两个可录入的字段，其它的字段，要么使用缺省值，要么
可以自动生成，要么是在特殊情况下使用的。</p>
</div>
<div class="section" id="id13">
<h3>处理不存在的字段<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<p>如果在添加时希望有一些不在Model中的字段，可以先在fields或AddForm中定义这个字段名，
然后在写一个get_form_field的回调，再将其传入AddView中即可，示例如下:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_form_field</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c">#其中name为对应的字段名</span>
    <span class="kn">from</span> <span class="nn">uliweb.form</span> <span class="kn">import</span> <span class="n">StringField</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;undefined&#39;</span><span class="p">:</span> <span class="c">#这里只是以&#39;undefined&#39;为例，实际可能叫别的</span>
        <span class="k">return</span> <span class="n">StringField</span><span class="p">(</span><span class="s">&#39;不存在的字段&#39;</span><span class="p">)</span>

<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="s">&#39;undefeined&#39;</span><span class="p">]</span>
<span class="n">view</span> <span class="o">=</span> <span class="n">AddView</span><span class="p">(</span><span class="s">&#39;blog&#39;</span><span class="p">,</span> <span class="n">ok_url</span><span class="o">=</span><span class="n">get_url</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
    <span class="n">get_form_field</span><span class="o">=</span><span class="n">get_form_field</span><span class="p">)</span>
<span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>上面是通过动态传入fields参数来添加不存在的字段，也可以在Model中的AddForm中定义。</p>
</div>
<div class="section" id="id14">
<h3>数据校验处理<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<p>从AddView的功能，我们大概可以了解到它会自动将Model转为一个Form，并且会有一些简单
的校验。如果在Field定义时我们指定了required=True，则这个字段在Form中将成为必输
项，如果用户不输入内容或输入为空的内容，则校验会失败。除了必输项，我们有可能需要
对某个字段或某几个字段进行校验，该如何操作。这里其实就直接使用了Form类本身的校验
功能。Form的校验分为两种，一种是单个字段的校验，一种是多个字段的联合校验。示例
代码如下:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RegisterForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">form_buttons</span> <span class="o">=</span> <span class="n">Submit</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Register&#39;</span><span class="p">),</span> <span class="n">_class</span><span class="o">=</span><span class="s">&quot;button&quot;</span><span class="p">)</span>
    <span class="n">form_title</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Register&#39;</span><span class="p">)</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Username&#39;</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Password&#39;</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password1</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Password again&#39;</span><span class="p">),</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">HiddenField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">uliweb.orm</span> <span class="kn">import</span> <span class="n">get_model</span>

        <span class="n">User</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;User &quot;</span><span class="si">%s</span><span class="s">&quot; is already existed!&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">form_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">all_data</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="n">all_data</span><span class="o">.</span><span class="n">password1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;password1&#39;</span> <span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Passwords are not match.&#39;</span><span class="p">)}</span>
</pre></div>
</div>
<p>上面是一个用户注册的Form，它要对用户名进行校验，还要对两次输入的密码进行校验。
对于用户名的校验采用了定义一个validate_fieldname的方式，其中fieldname是Form
中的字段。另一种方法是定义form_validate，它可以传入所有数据all_data，这样可以
同时检查多个字段。而validate_fieldname方法，只传入指定的字段值，所以无法同时检
查其它字段的值。如果有错误，对于validate_fieldname则只要返回一行出错原因的文本
即可。而form_validate则要返回一个出错的dict。其中key是出错的字段名。如果返回
None，则认为无错。在简单的情况下，你可以只写一个form_validate即可，所有的校验
都放在这里面处理。</p>
<p>这里的Form只是一个示例，在一般使用AddView或EditView时，你并不需要在Form中定义
任何Field。如果定义的话，它会和Model中的字段同时展示出来。</p>
</div>
<div class="section" id="form">
<h3>Form的布局处理<a class="headerlink" href="#form" title="永久链接至标题">¶</a></h3>
</div>
</div>
<div class="section" id="id15">
<h2>其它说明事项<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h2>
<div class="section" id="url">
<h3>URL定义规范<a class="headerlink" href="#url" title="永久链接至标题">¶</a></h3>
<p>为了处理的一致性，我们一般可以假设CRUD的功能采用以下的URL定义规则，假设我们采用
class-based View的写法，如:</p>
<div class="highlight-python"><pre>#coding=utf8

from uliweb import expose
from uliweb.orm import get_model

@expose('/blog')
class BlogView(object):
    def __init__(self):
        self.model = get_model('blog')

    @expose('')
    def list(self):

    def add(self):

    def edit(self, id):

    def view(self, id):

    def delete(self, id):</pre>
</div>
<p>整个View有一个前缀，所以后面的方法都是以这个前缀为基础，你可以根据需要调整路径，
每个功能对应的 URL 为:</p>
<dl class="docutils">
<dt>list</dt>
<dd><tt class="docutils literal"><span class="pre">/prefix</span></tt> 这里因为 list 对应的URL和前缀是一样的，所以我们使用 <tt class="docutils literal"><span class="pre">expose('')</span></tt> 生成
和前缀一样的 URL。</dd>
<dt>add</dt>
<dd><tt class="docutils literal"><span class="pre">/prefix/add</span></tt> 这里直接使用class-based的缺省函数映射方式，即: 前缀+&#8217;/&#8217;+方法</dd>
<dt>edit</dt>
<dd><tt class="docutils literal"><span class="pre">/prefix/edit/&lt;id&gt;</span></tt> 方法同上</dd>
<dt>view</dt>
<dd><tt class="docutils literal"><span class="pre">/prefix/view/&lt;id&gt;</span></tt> 方法同上</dd>
<dt>delete</dt>
<dd><tt class="docutils literal"><span class="pre">/prefix/delete/&lt;id&gt;</span></tt> 方法同上</dd>
</dl>
<p>如果你相把 &lt;id&gt; 放在动作前面，那么你要在每个方法前使用如:  <tt class="docutils literal"><span class="pre">&#64;expose('&lt;id&gt;/edit')</span></tt>
这样的方式。如果这个view函数还有其它的decorator，那么你要把 <tt class="docutils literal"><span class="pre">&#64;expose</span></tt> 放在前上面，
以保证函数名是正确的。同时其它的 decorator 在处理时一定要保证生成的新的函数名与
原来的函数名是一致的。</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">Generic 说明</a><ul>
<li><a class="reference internal" href="#genric">Genric是什么？</a></li>
<li><a class="reference internal" href="#listview">ListView</a><ul>
<li><a class="reference internal" href="#id1">ListView参数说明</a></li>
<li><a class="reference internal" href="#id2">字段列表定义</a></li>
<li><a class="reference internal" href="#id3">执行流程描述</a></li>
<li><a class="reference internal" href="#id4">字段转換</a></li>
<li><a class="reference internal" href="#id5">不存在字段支持</a></li>
<li><a class="reference internal" href="#view">跳转到 View 页面</a></li>
<li><a class="reference internal" href="#ajax">Ajax请求处理</a></li>
<li><a class="reference internal" href="#jquery-easyui">与jquery easyui的结合</a></li>
<li><a class="reference internal" href="#id6">分页处理</a></li>
<li><a class="reference internal" href="#id7">查询与条件</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simplelistview">SimpleListView</a><ul>
<li><a class="reference internal" href="#id8">参数说明</a></li>
</ul>
</li>
<li><a class="reference internal" href="#addview">AddView</a><ul>
<li><a class="reference internal" href="#id9">参数说明</a></li>
<li><a class="reference internal" href="#id10">简单代码示例</a></li>
<li><a class="reference internal" href="#id11">执行流程描述</a></li>
<li><a class="reference internal" href="#id12">录入字段的配置</a></li>
<li><a class="reference internal" href="#id13">处理不存在的字段</a></li>
<li><a class="reference internal" href="#id14">数据校验处理</a></li>
<li><a class="reference internal" href="#form">Form的布局处理</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id15">其它说明事项</a><ul>
<li><a class="reference internal" href="#url">URL定义规范</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="middleware.html"
                        title="上一章">Middleware 开发</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="test.html"
                        title="下一章">如何测试</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/generic.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="搜索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的模块，术语，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="test.html" title="如何测试"
             >下一页</a> |</li>
        <li class="right" >
          <a href="middleware.html" title="Middleware 开发"
             >上一页</a> |</li>
        <li><a href="index.html">Uliweb Documentation 0.1.4 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; 版权所有 2012, limodou.
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>