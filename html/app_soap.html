

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>soap &mdash; Uliweb Documentation 0.1.4 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="Uliweb Documentation 0.1.4 documentation" href="index.html" />
    <link rel="next" title="auth(用户认证处理)" href="app_auth.html" />
    <link rel="prev" title="staticfiles" href="app_staticfiles.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="app_auth.html" title="auth(用户认证处理)"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="app_staticfiles.html" title="staticfiles"
             accesskey="P">上一页</a> |</li>
        <li><a href="index.html">Uliweb Documentation 0.1.4 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="soap">
<h1>soap<a class="headerlink" href="#soap" title="永久链接至标题">¶</a></h1>
<p>Uliweb 为了支持soap的处理，提供了 uliweb.contrib.soap app。它依赖于以下模块:</p>
<dl class="docutils">
<dt>pysimplesoap</dt>
<dd>目前已经内置在uliweb/lib下了，不过这个版本做了一些改动，所以不能简单地使用
原来的包进行处理。主要改动是对SoapDispatcher类的，一方面可以在构造函数中可
以传入自定义的exception处理，另一方面是在dispatch()方法中添加了call_function
参数，以便对方法调用进行封装。</dd>
<dt>suds</dt>
<dd><p class="first">这个可以用来做为客户端的使用。不过uliweb中并没有内置它，需要自行安装。也可
以使用pysimplesoap带的client类。通过导入:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uliweb.lib.pysimplesoap.client</span> <span class="kn">import</span> <span class="n">SoapClient</span>
</pre></div>
</div>
<p class="last">不过目前感觉还有一些问题。</p>
</dd>
<dt>httplib2 或 pycurl</dt>
<dd>用于pysimplesoap的客户端处理。</dd>
</dl>
<div class="section" id="id1">
<h2>配置说明<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>使用soap服务，首先要在settings.ini中安装uliweb.contrib.soap。例如:</p>
<div class="highlight-python"><pre>[GLOBAL]
INSTALLED_APPS = [
...
'uliweb.contrib.soap',
...
]</pre>
</div>
<p>同时 uliweb.contrib.soap 的settings.ini下已经预设了一些配置项，用户可以根据需要
进行覆盖，如:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">DECORATORS</span><span class="p">]</span>
<span class="n">soap</span> <span class="o">=</span> <span class="s">&#39;uliweb.contrib.soap.soap&#39;</span>

<span class="p">[</span><span class="n">EXPOSES</span><span class="p">]</span>
<span class="n">soap_url</span> <span class="o">=</span> <span class="s">&#39;/SOAP&#39;</span><span class="p">,</span> <span class="s">&#39;uliweb.contrib.soap.views.soap&#39;</span>

<span class="p">[</span><span class="n">SOAP</span><span class="p">]</span>
<span class="n">namespace</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">documentation</span> <span class="o">=</span> <span class="s">&#39;Uliweb Soap Service&#39;</span>
<span class="n">name</span> <span class="o">=</span> <span class="s">&#39;UliwebSoap&#39;</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;pys&#39;</span>
</pre></div>
</div>
<p>首先它定义了一个soap的decorator，因此用户后面可以使用Decorators.soap来使用它，
后面会详细说明。</p>
<p>然后在EXPOSES中定义了外部访问时使用的URL，缺省为 <cite>&#8216;/SOAP&#8217;</cite> 。你可以根据需要进行
重定义。</p>
<p>然后是soap服务相关的一些描述信息。</p>
<dl class="docutils">
<dt>namespace</dt>
<dd>用来指明服务内部定义的一些名字空间的说明地址，缺省为None，表示和服务的URL是
一个地址。</dd>
<dt>documentation</dt>
<dd>服务的说明信息。</dd>
<dt>name</dt>
<dd>service的名字</dd>
<dt>prefix</dt>
<dd>名字空间的前缀，缺省为 &#8216;pys&#8217;。</dd>
</dl>
</div>
<div class="section" id="view">
<h2>View的定义<a class="headerlink" href="#view" title="永久链接至标题">¶</a></h2>
<p>服务已经安装好了，下面是定义相关的处理函数。通常你仍然可以定义在views.py中。但是
要注意，这里我们并不使用&#64;expose来处理，而是使用&#64;soap来处理，但是它仍然有view一样
的特性。不过，返回的内容不是HTML而是XML。</p>
<p>举例如下:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uliweb</span> <span class="kn">import</span> <span class="n">decorators</span>
<span class="kn">from</span> <span class="nn">uliweb.contrib.soap</span> <span class="kn">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">Decimal</span>

<span class="nd">@decorators.soap</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">returns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">},</span> <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;Hello:&#39;</span> <span class="o">+</span> <span class="n">a</span>
</pre></div>
</div>
<p>在pysimplesoap中定义了一些类型，用来描述数据类型的，uliweb已经将其导到 uliweb.contrib.soap
中，因此可以直接从这里导入。pysimplesoap采用内置类型和自定义类型相结合的方式，
比如常见的有:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">short</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span>
<span class="n">integer</span><span class="p">,</span> <span class="n">decimal</span><span class="p">,</span> <span class="n">dateTime</span><span class="p">,</span> <span class="n">date</span>
</pre></div>
</div>
<p>因此，对于服务描述使用的wsdl，采用自动生成的方式。</p>
<p>在上面的例子中，使用&#64;decorators.soap来定义一个soap服务。其中soap方法接受以下参
数:</p>
<dl class="docutils">
<dt>name</dt>
<dd>方法名，如果没有给出，则会自动将所修饰的函数名作为方法名。同时支持类方法的
方式。</dd>
<dt>returns</dt>
<dd>返回值描述。它是一个字典，可以进行嵌套描述。上例表示，返回值为一个简单
类型，tag名为&#8217;a&#8217;，值是&#8217;string&#8217;类型。缺省为None。</dd>
<dt>args</dt>
<dd>输入参数描述。它也是一个字典，定义方式同returns。缺省为None。如果为None，则
表示缺省为一个参数，可以是任意类型。</dd>
<dt>doc</dt>
<dd>方法描述说明。缺省为None。</dd>
</dl>
<p>因此在上例中，在soap中定义了三个参数:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;hello&#39;</span>
<span class="n">returns</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">}</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">}</span>
</pre></div>
</div>
<p>所以这个soap方法的名字叫 &#8216;hello&#8217;。</p>
<p>soap的下面为所修饰的函数。这里正好为hello，也可以为别的。它需要定义一个参数，名
为 &#8216;a&#8217;，与args中的定义要一致。</p>
<p>返回值直接为一个字符串。在返回时会自动对它进行封装。</p>
</div>
<div class="section" id="id2">
<h2>类型描述说明<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>类型描述就是针对returns和args的声明使用的。它支持简单类型手复杂类型。复杂类型
一般指：数组和字典。</p>
<p>当只有一个返回值时，一般定义为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="nb">type</span><span class="p">}</span>
</pre></div>
</div>
<p>这里type可以是前面说过的对象，如: int, str等。如果只有一个值，一般soap函数直接
返回就可以了，不必是一个字典的形式。</p>
<p>如果是多个值，一般定义为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;name1&#39;</span><span class="p">:</span><span class="n">type1</span><span class="p">,</span> <span class="s">&#39;name2&#39;</span><span class="p">:</span><span class="n">type2</span><span class="p">}</span>
</pre></div>
</div>
<p>定义为字典的形式。返回时应按说明返回一个字典。</p>
<p>如果是一个数组，一般定义为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:[</span><span class="nb">type</span><span class="p">]}</span>
<span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:{</span><span class="s">&#39;sub_name&#39;</span><span class="p">:</span><span class="nb">type</span><span class="p">}}</span>
</pre></div>
</div>
<p>有两种定义方式。第一种会自动转換为第二种形式。但是sub_name的名字是根据type的名
字自动生成的。所以:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:[</span><span class="nb">int</span><span class="p">]}</span>
</pre></div>
</div>
<p>其实就是:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:{</span><span class="s">&#39;int&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">}}</span>
</pre></div>
</div>
<p>以上几种数据定义方式可以嵌套使用，从而形成更复杂的数据格式定义。</p>
</div>
<div class="section" id="id3">
<h2>更复杂的一些示例<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>这个例子实现将上传的整数数组相加后返回:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@decorators.soap</span><span class="p">(</span><span class="n">returns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">},</span> <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:[</span><span class="nb">int</span><span class="p">]})</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
<p>这里a其实形式为: [{&#8216;int&#8217;:v1}, {&#8216;int&#8217;:v2}]</p>
<p>这个示例实现将上传字符串数组统一在后面添加 &#8216;中文&#8217; 信息:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@decorators.soap</span><span class="p">(</span><span class="n">returns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:[</span><span class="nb">str</span><span class="p">]},</span> <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:[</span><span class="nb">str</span><span class="p">]})</span>
<span class="k">def</span> <span class="nf">string</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;string&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">u&#39;中文&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
<p>建议使用unicode进行中文处理。返回仍是一个数组。</p>
</div>
<div class="section" id="id4">
<h2>客户端示例<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>以下以suds作为客户端来演示如何访问soap服务。以hello为例，首先准备一个服务端代码。
在某个app中的views.py中添加如下代码:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uliweb</span> <span class="kn">import</span> <span class="n">decorators</span>
<span class="kn">from</span> <span class="nn">uliweb.contrib.soap</span> <span class="kn">import</span> <span class="n">Date</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">Decimal</span>

<span class="nd">@decorators.soap</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">returns</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">},</span> <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;Hello:&#39;</span> <span class="o">+</span> <span class="n">a</span>
</pre></div>
</div>
<p>然后启动服务器，等待测试。</p>
<p>创建一个客户端的测试文件，写入如下代码:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#coding=utf8</span>
<span class="c">#import logging</span>
<span class="c">#logging.basicConfig()</span>
<span class="c">#logging.getLogger(&#39;suds.client&#39;).setLevel(logging.DEBUG)</span>

<span class="kn">from</span> <span class="nn">suds.client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s">&#39;http://localhost:8000/SOAP?wsdl&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">client</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="s">&#39;limodou&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;test1:&#39;</span><span class="p">,</span> <span class="n">result</span>
</pre></div>
</div>
<p>前几行是用来控制日志输出的。suds提供debug状态，可以根据程序处理的中间结果。这里
我已经注释掉了，你可以根据需要来使用。</p>
<p>首先是创建一个Client，只要传入一个wsdl的地址。这个地址就是前面的soap_url加上 <tt class="docutils literal"><span class="pre">?wsdl</span></tt> 。</p>
<p>然后我们可以打印看一下这个client是什么东西:</p>
<div class="highlight-python"><pre>Suds ( https://fedorahosted.org/suds/ )  version: 0.4 GA  build: R699-20100913

Service ( UliwebSoapService ) tns="http://localhost:8000/SOAP"
   Prefixes (0)
   Ports (1):
      (UliwebSoap)
         Methods (1):
            hello(xs:string a, )
         Types (0):</pre>
</div>
<p>可以看到我们定义的web service的一些信息，如有什么方法，需要什么参数等。</p>
<p>然后通过 client.service.hello(&#8216;limodou&#8217;) 来调用服务，结果会是:</p>
<div class="highlight-python"><pre>test1: Hello:limodou</pre>
</div>
<p>更详细的示例，可以参考 <a class="reference external" href="https://github.com/limodou/uliweb-doc">uliweb-doc/projects/soap_test</a> 中的代码。</p>
<p>另，通过设置apps/settings.ini:</p>
<blockquote>
<div>[LOG]
level = &#8216;debug&#8217;</div></blockquote>
<p>也可以看到后台在接收和发送应答时的XML信息。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">soap</a><ul>
<li><a class="reference internal" href="#id1">配置说明</a></li>
<li><a class="reference internal" href="#view">View的定义</a></li>
<li><a class="reference internal" href="#id2">类型描述说明</a></li>
<li><a class="reference internal" href="#id3">更复杂的一些示例</a></li>
<li><a class="reference internal" href="#id4">客户端示例</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="app_staticfiles.html"
                        title="上一章">staticfiles</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="app_auth.html"
                        title="下一章">auth(用户认证处理)</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/app_soap.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="搜索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的模块，术语，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="app_auth.html" title="auth(用户认证处理)"
             >下一页</a> |</li>
        <li class="right" >
          <a href="app_staticfiles.html" title="staticfiles"
             >上一页</a> |</li>
        <li><a href="index.html">Uliweb Documentation 0.1.4 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; 版权所有 2012, limodou.
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>